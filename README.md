# zabbix-gammu-smsd

send sms from zabbix server to phone number in case of events.

receive sms from phone number and execute appropriate script based on sms text.

All message sending & receiving is performed by <a href="https://wammu.eu/docs/manual/smsd/">gammu-smsd</a>.

# Steps
1- You need a GSM modem with working SIM card connected to zabbix server. I personally use Wavecom that connects through USB port
<pre>
// is your OS detects your modem?
#dmesg | grep ttyUSB
usb 1-2: pl2303 converter now attached to ttyUSB0
// so my GSM modem is connected to /dev/ttyUSB0
// you can connect to it with tools like minicom and issue some AT command
</pre>

2- Install gammu & gammu-smsd from repo or from source. I personally instelled latest version (1.38.0) from source code with following commands:
<pre>
#cd ~
#mkdir src
#cd src
#sudo yum group install 'Development Tools'
#wget https://cmake.org/files/v3.7/cmake-3.7.1.tar.gz
#tar zxvf cmake-3.7.1.tar.gz
#cd cmake-3.7.1
#./bootstrap --prefix=/usr
#gmake
#sudo gmake install
#export CMAKE_ROOT=/usr/share/cmake-3.7
#cd ..
#wget https://dl.cihar.com/gammu/releases/gammu-1.38.0.tar.gz
#tar zxvf gammu-1.38.0.tar.gz 
#cd gammu-1.38.0
#./configure --prefix=/usr
#make
#sudo make install
</pre>

3- config gammu and make sure gammu detects your GSM Modem
<pre>
#gammu-config
// generated by gammu-config
#cat ~/.gammurc
[gammu]
port = /dev/ttyUSB0
model = 
connection = at115200
synchronizetime = yes
logfile = 
logformat = nothing
use_locking = 
gammuloc = 

//send test message with gammu:
#echo "hello" | gammu --sendsms TEXT "+98XXXXXXXXXXX"
</pre>

4- create database for using in gammu-smsd
<pre>
// install mysql server
#wget http://dev.mysql.com/get/mysql57-community-release-el7-7.noarch.rpm
#yum localinstall mysql57-community-release-el7-7.noarch.rpm
#yum repolist enabled | grep "mysql.*-community.*"
#yum install mysql-community-server
#systemctl enable mysqld.service
#systemctl start mysqld.service
// determine mysql root temporary password
#grep 'temporary password' /var/log/mysqld.log
#mysql_secure_installation
//login to mysql
#mysql -uroot -p
mysql> create database smsdb;
mysql> grant all privileges on smsdb.* to 'smsd'@'localhost' identified by 'passw0rd';
mysql> flush privileges;
mysql> quit;

// import gammu-smsd mysql schema to database
#cd ~/src/gammu-1.38.0/docs/sql
// replace date string in mysql.sql file to avoid mysql error
#sed -ie 's/0000-00-00/1980-01-01/g' mysql.sql
#mysql -u smsd -p smsdb < mysql.sql
</pre>

5- config gammu-smsd : (see "man gammu-smsdrc" for details)
<pre>
// edit configuration file
#nano /etc/gammu-smsdrc
[gammu]
port = /dev/ttyUSB0
connection = at115200

[smsd]
service = sql
driver = native_mysql
host = localhost
user = smsd
password = passw0rd
database = smsdb
debuglevel = 1
LogFile = /var/log/gammu/smsd.log
RunOnReceive = /opt/gammu/sms-parser.sh
InboxFormat = unicode
OutboxFormat = unicode
TransmitFormat = auto

// create log & script directories
#mkdir -p /var/log/gammu
#mkdir -p /opt/gammu

// restart gammu-smsd service
#systemctl restart gammu-smsd

// chack log file for ensure everything is working
#tail -fn10 /var/log/gammu/smsd.log
// you should see something like this:
Sat 2017/01/14 13:35:33 gammu-smsd[19930]: mode: Send=1, Receive=1
Sat 2017/01/14 13:35:33 gammu-smsd[19930]: deliveryreport = no
Sat 2017/01/14 13:35:33 gammu-smsd[19930]: phoneid = 
Sat 2017/01/14 13:35:33 gammu-smsd[19931]: Connected to Database: smsdb on localhost
Sat 2017/01/14 13:35:33 gammu-smsd[19931]: Database structures version: 16, SMSD current version: 16
Sat 2017/01/14 13:35:33 gammu-smsd[19931]: Connected to Database native_mysql: smsdb on localhost
Sat 2017/01/14 13:35:33 gammu-smsd[19931]: Created POSIX RW shared memory at 0x7f400cfdd000
Sat 2017/01/14 13:35:33 gammu-smsd[19931]: Starting phone communication...
Sat 2017/01/14 13:35:38 gammu-smsd[19931]: Inserting phone info
Sat 2017/01/14 13:35:39 gammu-smsd[19931]: Read 0 messages

// send test message with gammu-smsd-inject ( see "man gammu-smsd-inject" )
#gammu-smsd-inject TEXT +98XXXXXXXXXX -text "message"
</pre>

6- configure zabbix for sending sms
<pre>
// copy zabbix alert script to corresponding path
#chmod +x sendsms.sh
#cp sendsms.sh /usr/lib/zabbix/alertscripts
// test script from command line!
#/usr/lib/zabbix/alertscripts +98XXXXXXXXXXX hello-from-zabbix-server
// zabbix user can not send sms without permission, so give this permission to zabbix user
#visudo
// add following line to /etc/sudoers so zabbix user can send sms
zabbix  ALL=NOPASSWD:/usr/bin/gammu-smsd-inject
</pre>

## create script media type in your zabbix server administration page
![z1](https://cloud.githubusercontent.com/assets/6551116/21954448/2c6cfc50-da66-11e6-8239-e1fb073d32a0.png)


